---
- import_playbook: bastion.yaml

- hosts: bastion
  tasks:
    - name: Symlink ansible-network/windmill-config directory
      file:
        src: ~/src/github.com/ansible-network/windmill-config
        dest: ~/.config/windmill
        state: link

    - name: Symlink ansible configuration file
      file:
        src: ~/src/github.com/ansible-network/windmill-config/ansible/ansible.cfg
        dest: ~/.ansible.cfg
        state: link

    - name: Create tmp directory for logs
      register: tmp_logs
      tempfile:
        state: directory

    - name: Bootstrap tox environment
      args:
        chdir: "{{ item }}"
      environment:
        PYTHONUNBUFFERED: 1
      shell: "{{ ansible_user_dir }}/.local/bin/tox -evenv --notest"
      with_items:
        - ~/src/git.openstack.org/openstack/windmill-ops
        - ~/src/git.openstack.org/openstack/windmill
        - ~/src/git.openstack.org/openstack/windmill-backup

    - name: Install ansible roles via galaxy
      args:
        chdir: "{{ item }}"
        executable: /bin/bash
      environment:
        PYTHONUNBUFFERED: 1
      shell: source .tox/venv/bin/activate; ./tools/install_roles.sh --force
      with_items:
        - ~/src/git.openstack.org/openstack/windmill-ops
        - ~/src/git.openstack.org/openstack/windmill
        - ~/src/git.openstack.org/openstack/windmill-backup

    - block:
        - name: Deploy windmill-ops with ansible-playbook
          args:
            chdir: ~/src/git.openstack.org/openstack/windmill-ops
          environment:
            PYTHONUNBUFFERED: 1
          shell: "{{ ansible_user_dir }}/.local/bin/tox -evenv -- ansible-playbook -v playbooks/bootstrap/site.yaml"

        - name: Deploy windmill with ansible-playbook
          args:
            chdir: "{{ item }}"
          environment:
            PYTHONUNBUFFERED: 1
          shell: "{{ ansible_user_dir }}/.local/bin/tox -evenv -- ansible-playbook -v playbooks/site.yaml"
          with_items:
            - ~/src/git.openstack.org/openstack/windmill
            - ~/src/git.openstack.org/openstack/windmill-backup

      always:
        - name: Generage UUID from ARA
          args:
            chdir: ~/src/git.openstack.org/openstack/windmill
          environment:
            PYTHONUNBUFFERED: 1
          register: windmill_uuid
          shell: ".tox/venv/bin/ara playbook list | grep windmill/playbooks/site.yaml | tail -1 | cut -d' ' -f2"

        - name: Generage UUID from ARA
          args:
            chdir: ~/src/git.openstack.org/openstack/windmill
          environment:
            PYTHONUNBUFFERED: 1
          register: windmill_backup_uuid
          shell: ".tox/venv/bin/ara playbook list | grep windmill-backup/playbooks/site.yaml | tail -1 | cut -d' ' -f2"

        - name: Generate static HTML for ARA results
          args:
            chdir: ~/src/git.openstack.org/openstack/windmill
          environment:
            PYTHONUNBUFFERED: 1
          shell: ".tox/venv/bin/ara generate html {{ tmp_logs.path }}/ara-report --playbook {{ windmill_uuid.stdout }} {{ windmill_backup_uuid.stdout }}"

        - name: Ensure zuul-output directory exists
          delegate_to: localhost
          file:
            path: "{{ zuul.executor.log_root }}/bastion"
            state: directory

        - name: Synchronize zuul-output back to zuul
          synchronize:
            dest: "{{ zuul.executor.log_root }}/bastion"
            mode: pull
            src: "{{ tmp_logs.path }}/"

        - name: Delete tmp directory for logs
          file:
            path: "{{ tmp_logs.path }}"
            state: absent
